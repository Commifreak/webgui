Menu="KVM:3"
Title="Add XML"
Cond="(pgrep('libvirtd')!==false)"
Markdown="false"
---
<link rel="stylesheet" href="/plugins/dynamix.kvm.manager/scripts/codemirror/lib/codemirror.css">
<link rel="stylesheet" href="/plugins/dynamix.kvm.manager/scripts/codemirror/addon/hint/show-hint.css">
<style type="text/css">
	.CodeMirror { border: 1px solid #eee; cursor: text; }
</style>
<div>
	<form method="POST" id="addxml" action="?subaction=domain-define" >
		<table class="tablesorter kvm-span" style="margin-top:-21px">
			<thead><th>Create New Domain XML Description</th></thead>
			<tr>
				<td style="padding: 0 24px 0 0;">
					<textarea autofocus spellcheck="false" id="addcode" name="xmldesc" rows="15" cols="100%" placeholder="Copy & Paste Domain XML Configuration Here."></textarea>
				</td>
			</tr>
			<tr>
				<td>
					<div style="margin-left:24px">
						<input type="submit" value="Create">
					</div>
				</td>
			</tr>
		</table>
	</form>
</div>
<script src="/plugins/dynamix.kvm.manager/scripts/codemirror/lib/codemirror.js"></script>
<script src="/plugins/dynamix.kvm.manager/scripts/codemirror/addon/hint/show-hint.js"></script>
<script src="/plugins/dynamix.kvm.manager/scripts/codemirror/addon/hint/xml-hint.js"></script>
<script src="/plugins/dynamix.kvm.manager/scripts/codemirror/addon/hint/libvirt-schema.js"></script>
<script src="/plugins/dynamix.kvm.manager/scripts/codemirror/mode/xml/xml.js"></script>
<script>
	$(function() {
		function completeAfter(cm, pred) {
			var cur = cm.getCursor();
			if (!pred || pred()) setTimeout(function() {
				if (!cm.state.completionActive)
					cm.showHint({completeSingle: false});
			}, 100);
			return CodeMirror.Pass;
		}

		function completeIfAfterLt(cm) {
			return completeAfter(cm, function() {
				var cur = cm.getCursor();
				return cm.getRange(CodeMirror.Pos(cur.line, cur.ch - 1), cur) == "<";
			});
		}

		function completeIfInTag(cm) {
			return completeAfter(cm, function() {
				var tok = cm.getTokenAt(cm.getCursor());
				if (tok.type == "string" && (!/['"]/.test(tok.string.charAt(tok.string.length - 1)) || tok.string.length == 1)) return false;
				var inner = CodeMirror.innerMode(cm.getMode(), tok.state).state;
				return inner.tagName;
			});
		}

		var editor = CodeMirror.fromTextArea(document.getElementById("addcode"), {
			mode: "xml",
			lineNumbers: true,
			extraKeys: {
				"'<'": completeAfter,
				"'/'": completeIfAfterLt,
				"' '": completeIfInTag,
				"'='": completeIfInTag,
				"Ctrl-Space": "autocomplete"
			},
			hintOptions: {schemaInfo: getLibvirtSchema()}
		});
	});
</script>
