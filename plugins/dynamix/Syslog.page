Menu="UNRAID-OS"
Title="System Log"
---
<?PHP
/* Copyright 2015, Lime Technology
 * Copyright 2015, Bergware International.
 *
 * This program is free software; you can redistribute it and/or
 * modify it under the terms of the GNU General Public License version 2,
 * as published by the Free Software Foundation.
 *
 * The above copyright notice and this permission notice shall be included in
 * all copies or substantial portions of the Software.
 */
?>
<style>
font.error {color:#D8000C;background-color:#FFBABA;}
font.warn {color:#9F6000;background-color:#FEEFB3;}
font.system {color:#00529B;background-color:#BDE5F8;}
font.array {color:#4F8A10;background-color:#DFF2BF;}
font.xs {font-size:small;padding:2px 0 2px 6px;margin-right:6px;}
</style>
<?
$zip = str_replace(' ','_',strtolower($var['NAME']))."-syslog-".date('Ymd-Hi').".zip";

$match = [['class' => 'error', 'text' => ['error','emask ','parity incorrect','fsck','invalid opcode: ','nobody cared','unknown boot option',' ata[0-9\. ]+: disabled',' dma disabled','kernel bug ','write protect is on','call trace','tainted','kernel:  \[','out[ _]of[ _]memory','killed','hpa detected: current [0-9]*055,']],
          ['class' => 'warn',  'text' => [' acpi error ','preclear_disk',' acpi warning',' acpi exception','spurious','hpa','host protected area','invalid signature',' (soft|hard) resetting ',' failed[ ,]','\<errno=[^0]',' limiting speed to ',': replayed ','duplicate object',' checksum','warning','conflicts','kill','power failure','power is back']],
          ['class' => 'system','text' => [' checksumming','get value of subfeature','linux version','mhz processor','cpu: intel','cpu[0-9]: intel','cpu: amd','cpu[0-9]: amd','kernel: processors: ','kernel: memory: ','kernel: smp: ','b highmem ',' lowmem ',' md: xor using','bogomips','kernel: console: ',' thermal zone',' adding [0-9]+k swap on ','kernel command line:','_sse','found.*chip','controller','version ','mouse|speaker|kbd port|aux port|ps\/2|keyboard','driver']],
          ['class' => 'array', 'text' => [': unraid system','lime[ -]tech','key detected, registered',': unregistered',' mdcmd ',' md: ','super.dat ',': running, size:']]
         ];

$lines = @file('/var/log/syslog',FILE_IGNORE_NEW_LINES|FILE_SKIP_EMPTY_LINES);
echo "<pre class='up'>";
foreach ($lines as $line) {
  $font = "font";
  foreach ($match as $row) foreach ($row['text'] as $text) if (preg_match("/$text/i",$line)) {$font = "font class='{$row['class']}'"; break 2;}
  echo "<$font>$line</font><br>";
}
echo "</pre>";
?>
<input type="button" value="Download" onclick="syslog()"><input type="button" value="Done" onclick="done()">
<script>
function cleanUp() {
  if (document.hasFocus()) {
    $('input[value="Downloading..."]').val('Download').prop('disabled',false);
    $.post('/webGui/include/Download.php',{cmd:'delete',file:'<?=$zip?>'});
  } else {
    setTimeout(cleanUp,4000);
  }
}
function syslog() {
  $('input[value="Download"]').val('Downloading...').prop('disabled',true);
  $.post('/webGui/include/Download.php',{cmd:'save',source:'/var/log/syslog',file:'<?=$zip?>'},function(zip) {
    location = zip;
    setTimeout(cleanUp,4000);
  });
}
function highlight(checked,line) {
  if (checked) {
    if (line=='E') $('font.error-').toggleClass('error error-');
    if (line=='W') $('font.warn-').toggleClass('warn warn-');
    if (line=='S') $('font.system-').toggleClass('system system-');
    if (line=='A') $('font.array-').toggleClass('array array-');
  } else {
    if (line=='E') $('font.error').toggleClass('error error-');
    if (line=='W') $('font.warn').toggleClass('warn warn-');
    if (line=='S') $('font.system').toggleClass('system system-');
    if (line=='A') $('font.array').toggleClass('array array-');
  }
}
$('.tabs').append("<span class='status vhshift'><font class='error xs'>Error:<input type='checkbox' onclick='highlight(this.checked,\"E\")' checked></font><font class='warn xs'>Warning:<input type='checkbox' onclick='highlight(this.checked,\"W\")' checked></font><font class='system xs'>System:<input type='checkbox' onclick='highlight(this.checked,\"S\")' checked></font><font class='array xs'>Array:<input type='checkbox' onclick='highlight(this.checked,\"A\")' checked></font><input type='button' value='Download' onclick='syslog()'></span>");
</script>