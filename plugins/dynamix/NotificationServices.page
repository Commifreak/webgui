Menu="Notifications:3"
Title="Notification Services"
---
<?
$xml_file = "/usr/local/emhttp/plugins/dynamix/include/NotificationServices.xml";
$agents_dir = "/boot/config/plugins/dynamix/notifications/agents";
$agents_disabled = "/boot/config/plugins/dynamix/notifications/agents-disabled";
if(!is_dir($agents_dir)) @mkdir($agents_dir,0755,TRUE);
if(!is_dir($agents_disabled)) @mkdir($agents_disabled,0755,TRUE);
?>
<script type="text/javascript">
  Scripts = new Object();
  if (!String.prototype.format) {
    String.prototype.format = function() {
      var args = arguments;
      return this.replace(/{(\d+)}/g, function(match, number) {
        return typeof args[number] != 'undefined' ? args[number] : match;
      });
    };
  }
  function prepareService(el, name) {
    var script = Scripts[name];
    var vars = "";
    form = $(el).parents('form:first');
    form.find(".variable").each(function(){
      vars += $(this).attr('name')+'="'+$(this).val()+"\"\n";
    });
    FileEnabled = form.find("input[name=FileEnabled]").val();
    FileDisabled = form.find("input[name=FileDisabled]").val();
    if (form.find("select[name=Enabled]").val() == "yes") {
      form.find("input[name=#command]").val("/usr/bin/mv -f '"+FileDisabled+"' '"+FileEnabled+"'");
    } else {
      form.find("input[name=#command]").val("/usr/bin/mv -f '"+FileEnabled+"' '"+FileDisabled+"'");
    }
    form.find('input[name=text]').val(script.format(vars,"\n"));
  }
  function execCmd(command) {
    form = $("#formExec");
    form.find("input[name=#command]").val(command);
    form.submit();
  }
  function testService(name, file) {
    form = $("#formExec");
    form.find("input[name=#command]").val(file);
    $('<input type="hidden" name="env" value="EVENT='+name+' test.|SUBJECT='+name+' test.|DESCRIPTION='+name+' test.|IMPORTANCE=normal">"').appendTo(form);
    form.submit();
    execCmd(file);
  }
</script>
<form method='POST' id="formExec" action='/update.php' target='progressFrame'>
<input type='hidden' name='#command' value=''>
</form>
<?
$xml = @simplexml_load_file($xml_file) or die("Fail opening $xml_file");
foreach ($xml->Agent as $agent) {
  $Name = $agent->Name;
  $FileEnabled = "${agents_dir}/${Name}.sh";
  $FileDisabled = "${agents_disabled}/${Name}.sh";
  if (file_exists($FileDisabled)) {
    $File = $FileDisabled;
    if (is_file($FileEnabled)) unlink($FileEnabled);
  } else {
    $File = $FileEnabled;
  }
  $Values = array();
  if (is_file($File)){
    preg_match("/[#]{6,100}(.*?)[#]{6,100}/si", file_get_contents($File), $match);
    if (isset($match[1])) $Values = parse_ini_string($match[1]);
  }
  foreach (explode(PHP_EOL,(String) $agent->Script) as $line) {
    if(trim($line)) $Script .= trim($line)."{1}";
  }
  echo "<div id='title' style='position:relative;margin:0px;top:-21px;'><img src='/plugins/dynamix/icons/".strtolower($Name).".png' class='icon' style='height:16px;width:16px;'>${Name}<span class='status'>".(is_file($FileEnabled) ? "<span class='green'>Enabled</span>": "<span class='red'>Disabled</span>")."</span></div>
        <form method='POST' action='/update.php' target='progressFrame'>
        <input type='hidden' name='#include' value='update.file.php'>
        <input type='hidden' name='#file' value='${File}'>
        <input type='hidden' name='#command' value=''>
        <input type='hidden' name='FileEnabled' value='$FileEnabled'>
        <input type='hidden' name='FileDisabled' value='$FileDisabled'>
        <input type='hidden' name='text' value=''>
        <dl><dt>Enabled</dt><dd><select name='Enabled' size='1'>";
        echo mk_option(is_file($FileDisabled), 'no', 'No');
        echo mk_option(is_file($FileEnabled), 'yes', 'Yes');
        echo "</select></dd></dl><script>Scripts['${Name}']=".json_encode($Script)."</script>";
  foreach ($agent->Variables->children() as $Var) {
    $vName = preg_replace('#\[([^\]]*)\]#', '<$1>', (string) $Var);
    $vDesc = preg_replace('#\[([^\]]*)\]#', '<$1>', (String) $Var->attributes()->Desc);
    $vDefault = preg_replace('#\[([^\]]*)\]#', '<$1>', (String) $Var->attributes()->Default);
    $vHelp = preg_replace('#\[([^\]]*)\]#', '<$1>', (String) $Var->attributes()->Help);
    echo "<dl><dt>${vDesc}</dt><dd><input name='${vName}' size='40' maxlength='80' class='variable' required value='".( isset($Values[$vName]) ? $Values[$vName] : $vDefault )."'></dd></dl>";
    if ($vHelp) echo "<blockquote class='inline_help'>$vHelp</blockquote>";
  }
  echo "<dl><dt>&nbsp;</dt><dd><input type='submit' onclick='prepareService(this, \"${Name}\")' value='Save'>";
  if (is_file($File)) {
    echo "<button type='button' onclick='execCmd(\"/usr/bin/rm $File\")'>Remove</button>";
    echo "<button type='button' onclick='testService(\"$Name\",\"$File\")'>Test</button>";
  }
  echo "<button type='button' onclick='done()'>Done</button></dd></dl></form><div style='min-height:50px;'></div>";
}
?>