Menu="Docker"
Title="Docker Apps"
Cond="(pgrep('docker')!==false)"
---
<?
include_once("/usr/local/emhttp/plugins/dynamix.docker.manager/dockerClient.php");
$DockerClient    = new DockerClient();
$DockerUpdate    = new DockerUpdate();
$DockerTemplates = new DockerTemplates();
?>
<link type="text/css" rel="stylesheet" href="/plugins/dynamix.docker.manager/assets/gh-buttons.css">
<link type="text/css" rel="stylesheet" href="/plugins/dynamix.docker.manager/assets/font-awesome-4.2.0/css/font-awesome.min.css">
<link type="text/css" rel="stylesheet" href="/plugins/dynamix.docker.manager/assets/jquery-ui/jquery-ui.min.css">
<link type="text/css" rel="stylesheet" href="/plugins/dynamix.docker.manager/assets/jquery-ui/jquery-ui.structure.min.css">
<link type="text/css" rel="stylesheet" href="/plugins/dynamix.docker.manager/assets/jquery-ui/jquery-ui.theme.min.css">
<link type="text/css" rel="stylesheet" href="/plugins/dynamix.docker.manager/assets/context.standalone.css">

<script type="text/javascript" src="/plugins/dynamix.docker.manager/assets/jquery-ui/jquery-ui.min.js"></script>
<script type="text/javascript" src="/plugins/dynamix.docker.manager/assets/detectmobilebrowser.js"></script>
<script type="text/javascript" src="/plugins/dynamix.docker.manager/assets/context.js"></script>
<script type="text/javascript" src="/plugins/dynamix.docker.manager/assets/docker.js"></script>
<style>
	body {
		-webkit-overflow-scrolling: touch;
	}
	label {
		display: inline-block;
		width: 3em;
	}
	iframe {
		overflow: 'scroll';
		-webkit-overflow-scrolling: touch;
	}
	h2 {
		color: #625D5D;
		letter-spacing: 0px;
		font-family: "Raleway",sans-serif;
		font-size: 32px;
		line-height: 1.2em;
		font-weight: 300;
		padding: 0px 0px 20px;
		margin: 0px;
	}
	.bannerToggle {
		cursor: pointer;
		color: #a3a3a3;
		letter-spacing: 0px;
		padding: 0px;
		font-family: "Raleway",sans-serif;
		font-size: 12px;
		line-height: 1.3em;
		font-weight: bold;
		margin: 0px;
	}
	.bannerToggle:hover,
	.bannerToggle:focus,
	.bannerToggle:active,
	.bannerToggle.active{
		color:#625D5D;
	}
	.apps_tabs {
		display: none;
	}
	.appblock {
		position: relative;
		display: inline-block;
		vertical-align: top;
		width: 350px;
		height: 75px;
		margin: 20px;
		background-color: #FFF;
		padding: 5px 5px 5px 5px;
		box-shadow: 0px 0px 5px 1px #E3E3E3;
		color: #444;
		border-radius: 3px;
	}
	.appblock.started {
		box-shadow: 0px 0px 5px 1px #009900;
	}
	.appblock.stopped {
		box-shadow: 0px 0px 10px 1px #EF3D47;
	}
	.status {
		background-color: #FFF;
		vertical-align: top;
		position: absolute;
		z-index: 1;
		right: -18px;
		top: -10px;
		display: block;
	}
	.started{
		color: #009900;
	}
	.stopped{
		color:#EF3D47;
	}
	.update {
		color: #3300FF;
	}
	.ctrbtn {
		position: absolute;
		vertical-align: top;
		text-align: right;
		z-index: 100;
		right: 5px;
		bottom: 0px;
		display: none;
	}
	.appblock:hover .ctrbtn,
	.appStopped:hover .ctrbtn{
		display: block;
	}
	.show {
		display: block;
	}
	.appblock:hover img {
		opacity: 0.4;
		filter: alpha(opacity=40); /* For IE8 and earlier */
	}
	.appblock:hover h2{
		color:#d3d3d3;
	}
	.menu {
	background: #545454;
	color:#fff;
	font-weight: normal;
	background: -moz-linear-gradient(top,  #545454 0%, #3f3f3f 100%);
	background: -webkit-gradient(linear, left top, left bottom, color-stop(0%,#545454), color-stop(100%,#3f3f3f));
	background: -webkit-linear-gradient(top,  #545454 0%,#3f3f3f 100%);
	background: -o-linear-gradient(top,  #545454 0%,#3f3f3f 100%);
	background: -ms-linear-gradient(top,  #545454 0%,#3f3f3f 100%);
	background: linear-gradient(to bottom,  #545454 0%,#3f3f3f 100%);
	filter: progid:DXImageTransform.Microsoft.gradient( startColorstr='#545454', endColorstr='#3f3f3f',GradientType=0 );
	border-top: 1px solid #6d6d6d;
	line-height: 20px;
	border-radius: 5px;
	}
</style>
<div style="text-align:right;vertical-align:top;position:relative;top:-46px;height:0;padding-right:5px">
	<span class="bannerToggle" onclick="reloadUpdate();"><i id="refreshToggle" class="fa fa-refresh fa-lg"></i> Reload info</span>&nbsp;&nbsp;&nbsp;
	<span class="bannerToggle" onclick="toggleLayout();"><i id="bannerToggle" class='fa fa-lg'></i> View banners</span>
</div>
<form method="POST" id="formStartStop" action="/update.php" target="progressFrame">
<input type="hidden" id="#cmdStartStop" name="#command" value="" />
</form>
<form markdown="1" id="formAutostart" method="POST" action="/plugins/dynamix.docker.manager/update_cfg.php" target="progressFrame">
<input type="hidden" name="#action" value="autostart" />
<input type="hidden" name="#container" value="none" />
</form>
<div id="dialog-confirm" style="display:none;" title="Dialog Title"></div>
<div id="iframe-popup" style="display:none;-webkit-overflow-scrolling:touch;"></div>
<script type="text/javascript">

context.init({ fadeSpeed: 100, filter: function ($obj){}, above: false, preventDoubleContext: false, compress: false });
$(function(){ $("i").tooltip( {track: true, show: { delay: 300 }} );});
$(function(){ $("img").tooltip( {track: true, show: { delay: 1000 }} );});

function addContextMenu(container, image, template, started, update, autostart, webui){
	var opts = [{header: container}];
	opts.push({text: 'WebUI', icon:'fa-globe', href: webui, target: '_blank' });
	opts.push({divider: true});
	if (! update){
		opts.push({text: 'Update', icon:'fa-arrow-down', action: function(e){ e.preventDefault(); execUpContainer(container); }});
		opts.push({divider: true});
	}
	if (started){
		opts.push({text: 'Stop', icon:'fa-stop', action: function(e){ e.preventDefault(); containerControl(container, 'stop'); }});
	} else {
		opts.push({text: 'Start', icon:'fa-play', action: function(e){ e.preventDefault(); containerControl(container, 'start'); }});
	}
	opts.push({divider: true});
	opts.push({text: 'Logs', icon:'fa-navicon', action: function(e){ e.preventDefault(); containerLogs(container); }});
	opts.push({text: 'Edit', icon:'fa-wrench', action: function(e){ e.preventDefault(); addContainer(container, template); }});
	if (autostart){
		opts.push({text: 'Disable autostart', icon:'fa-check-square-o', action: function(e){ e.preventDefault();  autoStart(container, e); }});
	} else {
		opts.push({text: 'Enable autostart', icon:'fa-square-o', action: function(e){ e.preventDefault(); autoStart(container, e); }});
	}
	opts.push({divider: true});
	opts.push({text: 'Remove', icon:'fa-trash', action: function(e){ e.preventDefault(); rmContainer(container, image); }});
	context.attach('#context-'+container, opts);
}

$( document ).ready(function() {
	if (jQuery.browser.mobile){
		$("[id=cntrl_btn]").addClass( "show" );
		$("img.banner").css( "opacity", "0.4" );
	}
	var cookie = readCookie("apps_layout");
	if (cookie){
		$("#apps_icons").css( "display", "none" );
		$("#apps_banners").css( "display", "block" );
		$("#bannerToggle").removeClass("fa-toggle-off");
		$("#bannerToggle").addClass("fa-toggle-on");
	} else {
		$("#apps_icons").css( "display", "block" );
		$("#apps_banners").css( "display", "none" );
		$("#bannerToggle").addClass("fa-toggle-off");
		$("#bannerToggle").removeClass("fa-toggle-on");
	}
});

function createCookie(name,value,days) {
	if (days) {
		var date = new Date();
		date.setTime(date.getTime()+(days*24*60*60*1000));
		var expires = "; expires="+date.toGMTString();
	}
	else var expires = "";
	document.cookie = name+"="+value+expires+"; path=/";
}

function readCookie(name) {
	var nameEQ = name + "=";
	var ca = document.cookie.split(';');
	for(var i=0;i < ca.length;i++) {
		var c = ca[i];
		while (c.charAt(0)==' ') c = c.substring(1,c.length);
		if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
	}
	return null;
}

function eraseCookie(name) {
	createCookie(name,"",-1);
}

function toggleLayout(){
	var cookie = readCookie("apps_layout");
	if (cookie){
		eraseCookie("apps_layout");
		$("#apps_icons").css( "display", "block" );
		$("#apps_banners").css( "display", "none" );
		$("#bannerToggle").addClass("fa-toggle-off");
		$("#bannerToggle").removeClass("fa-toggle-on");
	} else {
		createCookie("apps_layout","banner",3650)
		$("#apps_icons").css( "display", "none" );
		$("#apps_banners").css( "display", "block" );
		$("#bannerToggle").removeClass("fa-toggle-off");
		$("#bannerToggle").addClass("fa-toggle-on");
	}
}

function execUpContainer(container){
	var title = 'Updating the container: ' + container;
	var address = "/plugins/dynamix.docker.manager/createDocker.php?updateContainer=true&ct[]=" + container;
	popupWithIframe( title, address, true);
};
</script>
<?
$allContainers = $DockerClient->getDockerContainers();
if ( ! $allContainers) { $allContainers = array(); }

$info = $DockerTemplates->getAllInfo();

# Add icons DIV
echo "<div id=\"apps_icons\" class=\"apps_tabs\"><div class=\"PanelSet\">";
$contextMenus = array();

foreach ($allContainers as $ct) {
	$name           = $ct["Name"];
	$is_autostart   = ( $info[$name]['autostart'] ) ? 'true' : 'false';
	$updateStatus   = $info[$name]['updated'];
	$updateStatus   = ($updateStatus == "true" or $updateStatus == "undef" ) ? 'true' : 'false';
	$running        = ($ct['Running']) ? 'true' : 'false';
	$webGuiUrl      = $info[$name]['url'];
	$contextMenus[] = sprintf("\taddContextMenu('%s', '%s', '%s', %s, %s, %s, '%s');", $ct['Name'], $ct['ImageId'], $info[$name]['template'], $running, $updateStatus, $is_autostart, $webGuiUrl);
	$status         = ($ct["Running"]) ? "started" : "stopped";
	$status         = ($updateStatus == "false") ? "update" : $status;
	$Icon           = $info[$name]['icon'];

	if ( $Icon == "#" ){
		$Icon = "/plugins/dynamix.docker.manager/assets/images/question.png";
	}
	$Icon = "<img src=\"$Icon\" height=\"48px\">";
	$name="<span class=\"PanelText $status\">$name</span>";
	// if ($webGuiUrl != "#"){
	//   $Icon = "<a href=\"$webGuiUrl\" target=\"_blank\">$Icon</a>";
	//   $name = "<a class=\"PanelText $status\" href=\"$webGuiUrl\" target=\"_blank\">$name</a>";
	// }
	printf("
		<div class=\"Panel\">
			<div id='context-" . $ct["Name"] . "' style='display:block; cursor:pointer'>
				%s
				<div class=\"PanelText\">
					%s
				</div>
			</div>
		</div>", $Icon, $name);
}
echo "
<div class=\"Panel\">
	<div style='cursor:pointer' onclick=\"addContainer('');\">
		<img class=\"PanelImg\" src=\"/plugins/dynamix.docker.manager/assets/images/plus.png\" height=\"48px\">
		<div class=\"PanelText started\">
			Add
		</div>
	</div>
</div>
";
echo "</div></div>\n";
printf("<script type=\"text/javascript\">\n$( document ).ready(function() {\n%s\n});\n</script>", implode("\n", $contextMenus) );

# Add banners DIV
echo "<div id=\"apps_banners\" class=\"apps_tabs\">";
foreach ($allContainers as $ct) {
	$ctrbtn = "";

	$updateStatus = $info[$ct['Name']]['updated'];
	if ($updateStatus == "true" or $updateStatus == "undef"){
		$statusbadge = ($ct["Running"]) ? "<div class=\"status started\"><i class=\"fa fa-check-circle fa-lg\"></i></div>" :
															 				"<div class=\"status stopped\"><i class=\"fa fa-times-circle fa-lg\"></i></div>";
	} else {
		$statusbadge = ($ct["Running"]) ? "<div class=\"status update\"><i class=\"fa fa-arrow-circle-down fa-lg\"></i></div>" :
															 				"<div class=\"status stopped\"><i class=\"fa fa-arrow-circle-down fa-lg\"></i></div>";
		# Add update button
		$ctrbtn = "<i class=\"button blue\" onclick=\"execUpContainer('".$ct['Name']."');\" title=\"Update\"><i class=\"fa  fa-arrow-down fa-lg\"></i></i>$ctrbtn";
	}

	# Add start/stop button
	$ctrbtn .= ($ct["Running"]) ? '<i class="button danger" onclick="containerControl(\''.$ct['Name'].'\', \'stop\');" title="Stop"><i class="fa fa-stop fa-lg"></i></i>' :
															 '<i class="button green" onclick="containerControl(\''.$ct['Name'].'\', \'start\');" title="Start"><i class="fa fa-play fa-lg"></i></i>';

	# Add WebUI button
	$webGuiUrl = $info[$ct['Name']]['url'];
	if ($webGuiUrl != "#"){
		$ctrbtn .= "<i class=\"button\" onclick=\"window.open('$webGuiUrl','_blank');\" title=\"Web UI\"><i class=\"fa fa-globe fa-lg\"></i></i>";
	}

	# Add log button
	$ctrbtn .= '<i class="button" onclick="containerLogs(\''.$ct['Name'].'\');" title="Logs"><i class="fa fa-navicon fa-lg"></i></i>';

	# Add edit button
	$ctrbtn .= ($DockerTemplates->getUserTemplate($ct['Name'])) ? "<i class=\"button\" onclick=\"addContainer('". $ct['Name'] ."','". $info[$ct['Name']]['template'] ."');\" title=\"Edit\"><i class=\"fa fa-wrench fa-lg\"></i></i>" : "";

	# Add autostart button
	$ctrbtn .= ($info[$ct["Name"]]['autostart']) ? "<i class=\"button\" onclick=\"autoStart('".$ct['Name']."');\" title=\"Disable autostart\"><i class=\"fa fa-check-square-o fa-lg\"></i></i>" :
																													"<i class=\"button\" onclick=\"autoStart('".$ct['Name']."');\" title=\"Enable autostart\"><i class=\"fa fa-square-o fa-lg\"></i></i>";

	# Add remove button
	$ctrbtn .= "<i class=\"button\" onclick=\"rmContainer('" . $ct['Name'] . "','" . $ct["ImageId"] . "');\" title=\"Remove\"><i class=\"fa fa-trash fa-lg\"></i></i>";

	$banner = $info[$ct['Name']]['banner'];
	$content = ( $banner != "#") ? "<img src=\"$banner\" height=\"70px\" title='%s' class=\"banner\" style=\"position: relative; \">" :
	"<div><h2 style=\"padding: 15px; vertical-align: middle;\">%s</h2></div>";

	$ctnt = "
	<div class=\"appblock\">
		<div class=\"ctrbtn\" id=\"cntrl_btn\">
			<div class=\"button-group\" style=\"position:relative;\">
				%s
			</div>
		</div>
		%s
		<div style=\" display: table; width:350px; height:75px;background-color:#fff;\">
			<div style=\"vertical-align: middle; text-align: center; display: table-cell; \">
				<div style=\"color:#625D5D; display: inline-block;\">
					$content
				</div>
			</div>
		</div>
	</div>
	";
	printf($ctnt, $ctrbtn, $statusbadge , $ct["Name"] );
}
echo "
<div class=\"appblock\" style=\"background-color:#e1e1e1;\">
	<div style=\" display: table; width:100%; height:100%;\">
		<div style=\"vertical-align: middle; text-align: center; display: table-cell; \">
			<div class=\"fa fa-plus fa-4x\" style=\"color:#625D5D; width:50px; height: 50px; display: inline-block; cursor: pointer;\" onclick=\"addContainer('');\">
			</div>
		</div>
	</div>
</div>
";
?>
</div>
